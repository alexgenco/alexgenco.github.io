<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Axum | ~ag</title><link rel=canonical href=http://example.org/posts/axum/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Axum"><meta property="og:description" content="Alright FINE I&rsquo;ll write about software development. It only took me 2 freakin posts to run out of anything else to write about.
Rust I write a fair amount of Rust at work and try to keep up with hobby projects at home too. Recently I&rsquo;ve been writing a website to download Twitter data for people who, like me, expect Twitter to crash and burn any day now but want to save all their funny Likes somewhere permanent."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/axum/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-09T11:18:38-08:00"><meta property="article:modified_time" content="2023-01-09T11:18:38-08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Axum"><meta name=twitter:description content="Alright FINE I&rsquo;ll write about software development. It only took me 2 freakin posts to run out of anything else to write about.
Rust I write a fair amount of Rust at work and try to keep up with hobby projects at home too. Recently I&rsquo;ve been writing a website to download Twitter data for people who, like me, expect Twitter to crash and burn any day now but want to save all their funny Likes somewhere permanent."><link rel=stylesheet href=http://example.org/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=http://example.org/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=http://example.org/posts/guitar-time/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=http%3a%2f%2fexample.org%2fposts%2faxum%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&text=Axum" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&title=Axum" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&is_video=false&description=Axum" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Axum&body=Check out this article: http%3a%2f%2fexample.org%2fposts%2faxum%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&title=Axum" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&title=Axum" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&name=Axum&description=Alright%20FINE%20I%26rsquo%3bll%20write%20about%20software%20development.%20It%20only%20took%20me%202%20freakin%20posts%20to%20run%20out%20of%20anything%20else%20to%20write%20about.%0aRust%20I%20write%20a%20fair%20amount%20of%20Rust%20at%20work%20and%20try%20to%20keep%20up%20with%20hobby%20projects%20at%20home%20too.%20Recently%20I%26rsquo%3bve%20been%20writing%20a%20website%20to%20download%20Twitter%20data%20for%20people%20who%2c%20like%20me%2c%20expect%20Twitter%20to%20crash%20and%20burn%20any%20day%20now%20but%20want%20to%20save%20all%20their%20funny%20Likes%20somewhere%20permanent." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=http%3a%2f%2fexample.org%2fposts%2faxum%2f&t=Axum" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#rust>Rust</a></li><li><a href=#rust-web>Rust Web</a></li><li><a href=#axum>Axum</a><ul><li><a href=#intoresponse><code>IntoResponse</code></a></li><li><a href=#fromrequest-and-extractors><code>FromRequest</code> and Extractors</a></li><li><a href=#custom-extractors>Custom Extractors</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Axum</h1><div class=meta><div class=postdate><time datetime="2023-01-09 11:18:38 -0800 -0800" itemprop=datePublished>2023-01-09</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/dev rel=tag>dev</a></div></div></header><div class=content itemprop=articleBody><p>Alright FINE I&rsquo;ll write about software development. It only took me 2 freakin posts to run out of anything else to write about.</p><h2 id=rust>Rust</h2><p>I write a fair amount of Rust at work and try to keep up with hobby projects at home too. Recently I&rsquo;ve been writing a website to download Twitter data for people who, like me, expect Twitter to crash and burn any day now but want to save all their funny Likes somewhere permanent. Like this one:</p><p>There were a few tools to do this out there already, but I either couldn&rsquo;t get them to work, they cost money, or they didn&rsquo;t save the data in a very helpful format. Anyway this project may never see the light of day, but I will at least put down some things I learned so far about the Axum web framework.</p><h2 id=rust-web>Rust Web</h2><p>At work, we use Rust for our core delivery stack, our Kafka consumer applications, and recently for a couple gRPC microservices. However, we don&rsquo;t yet have any straight-up HTTP applications written in Rust, so I&rsquo;m not really familiar with any HTTP frameworks. Based on Google results, it seems like Rocket is the most popular, but for some reason I decided to use <a href=https://docs.rs/axum/latest/axum/>Axum</a> for this (I honestly can&rsquo;t remember why I picked it, maybe there was a sexy blog post about it on HN that day, idk). Like most of my hobby projects, I probably could have done this a lot faster with Ruby/Rails, but the idea of starting a Rails project these days is a huge bummer for some reason.</p><h2 id=axum>Axum</h2><p>Axum has the usual HTTP frameworky things, like handlers and middleware. Handlers are basically functions that accept any number of &ldquo;extractors&rdquo;, which implement <code>FromRequest</code>, and return anything that implements <code>IntoResponse</code>.</p><h3 id=intoresponse><code>IntoResponse</code></h3><p>A lot of things implement this trait; I think it&rsquo;s meant to be implemented on anything you would reasonably expect to represent an HTTP response. One of the most basic ones is the tuple <code>(http::StatusCode, &'static str)</code>, i.e. the status and the text body. There are more sophisticated implementations too, like <a href=https://docs.rs/axum/latest/axum/response/struct.Sse.html><code>Sse</code></a>, which is a server-sent event struct that wraps a <code>Stream</code> and writes each stream result to the client via websockets.</p><h3 id=fromrequest-and-extractors><code>FromRequest</code> and Extractors</h3><p>Like <code>IntoResponse</code>, there are a lot of things that implement this trait. It seems like the general term for them are &ldquo;extractors&rdquo;, because they extract information encoded in the request. For instance here&rsquo;s how you get the JSON request body:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>json_handler</span>(Json(my_struct): <span style=color:#a6e22e>Json</span><span style=color:#f92672>&lt;</span>MyStruct<span style=color:#f92672>&gt;</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p><code>Json&lt;T></code> is an extractor that deserializes the JSON request body into any struct <code>T</code>, which must implement <code>serde::Deserialize</code>. In the function body, <code>my_struct</code> is the resulting instance of <code>MyStruct</code>.</p><h3 id=custom-extractors>Custom Extractors</h3><p>Writing extractors is easy! You just need to implement either <code>FromRequest</code> or <code>FromRequestParts</code>. The latter is a little simpler I think. It has an associated type <code>Rejection</code>, which is sort of like the error type that is returned when the extractor fails, and which must implement our old friend <code>IntoResponse</code>. For example in my Twitter project I wrote a custom extractor for fetching OAuth user data from the session. <em>Buckle up</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[async_trait]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span>S<span style=color:#f92672>&gt;</span> FromRequestParts<span style=color:#f92672>&lt;</span>S<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> TwitterUser
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    S: Send <span style=color:#f92672>+</span> Sync,
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Rejection</span> <span style=color:#f92672>=</span> AuthRedirect;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>from_request_parts</span>(parts: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Parts, _: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>S</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Self, Self::Rejection<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> session <span style=color:#f92672>=</span> parts.extract::<span style=color:#f92672>&lt;</span>ReadableSession<span style=color:#f92672>&gt;</span>().<span style=color:#66d9ef>await</span>.map_err(<span style=color:#f92672>|</span>e<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>            error<span style=color:#f92672>!</span>(error <span style=color:#f92672>=</span> <span style=color:#f92672>%</span>e, <span style=color:#e6db74>&#34;extracting user session&#34;</span>);
</span></span><span style=display:flex><span>            AuthRedirect
</span></span><span style=display:flex><span>        })<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> user <span style=color:#f92672>=</span> session
</span></span><span style=display:flex><span>            .get::<span style=color:#f92672>&lt;</span>TwitterUser<span style=color:#f92672>&gt;</span>(TWITTER_USER_KEY)
</span></span><span style=display:flex><span>            .ok_or(AuthRedirect)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Ok(user)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So <code>from_request_parts</code> is the required method here. <code>TwitterUser</code> is a struct containing things like the user&rsquo;s ID and access token. These are stored in the session after the whole OAuth dance (which was a bit of a headache to get working, but that&rsquo;s for another post). <code>AuthRedirect</code> is a unit struct that implements <code>IntoResponse</code> such that it redirects to the login page if the user doesn&rsquo;t exist in the session or is malformed.</p><p>The interesting bit here is that you can call other extractors from within your extractor. Notice the <code>parts.extract::&lt;ReadableSession>()</code> part; that&rsquo;s just another extractor that comes from the <code>axum_sessions</code> crate.</p><p>And finally, using the extractor in a handler is beautifully declarative:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handler</span>(user: <span style=color:#a6e22e>TwitterUser</span>) -&gt; <span style=color:#a6e22e>impl</span> IntoResponse {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>The handler just says &ldquo;Give me a <code>TwitterUser</code>, I don&rsquo;t care where it comes from&rdquo;. And axum is like &ldquo;You got it&rdquo;. And you know that once you&rsquo;re inside the handler function, you have valid Twitter data to work with.</p><p>Bingo Bango Bongo</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#rust>Rust</a></li><li><a href=#rust-web>Rust Web</a></li><li><a href=#axum>Axum</a><ul><li><a href=#intoresponse><code>IntoResponse</code></a></li><li><a href=#fromrequest-and-extractors><code>FromRequest</code> and Extractors</a></li><li><a href=#custom-extractors>Custom Extractors</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=http%3a%2f%2fexample.org%2fposts%2faxum%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&text=Axum" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&title=Axum" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&is_video=false&description=Axum" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Axum&body=Check out this article: http%3a%2f%2fexample.org%2fposts%2faxum%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&title=Axum" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&title=Axum" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=http%3a%2f%2fexample.org%2fposts%2faxum%2f&name=Axum&description=Alright%20FINE%20I%26rsquo%3bll%20write%20about%20software%20development.%20It%20only%20took%20me%202%20freakin%20posts%20to%20run%20out%20of%20anything%20else%20to%20write%20about.%0aRust%20I%20write%20a%20fair%20amount%20of%20Rust%20at%20work%20and%20try%20to%20keep%20up%20with%20hobby%20projects%20at%20home%20too.%20Recently%20I%26rsquo%3bve%20been%20writing%20a%20website%20to%20download%20Twitter%20data%20for%20people%20who%2c%20like%20me%2c%20expect%20Twitter%20to%20crash%20and%20burn%20any%20day%20now%20but%20want%20to%20save%20all%20their%20funny%20Likes%20somewhere%20permanent." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=http%3a%2f%2fexample.org%2fposts%2faxum%2f&t=Axum" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2023 Alex Genco</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script></html>